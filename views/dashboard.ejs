<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CL Message</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title glitch" data-text="DASHBOARD">DASHBOARD</h1>
            <p class="subtitle">Sistema de Gerenciamento de Mensagens</p>
        </div>

        <div class="cyber-card user-info">
            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                <img src="<%= user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : '/default-avatar.png' %>" 
                     alt="Avatar" class="user-avatar">
                <div>
                    <h2>Bem-vindo, <%= user.username %>#<%= user.discriminator %></h2>
                    <p>ID: <%= user.id %></p>
                    <p style="color: #ff0000; font-size: 0.9rem; margin-top: 0.5rem;">
                        ‚úÖ Sess√£o salva por 30 dias - Token salvo automaticamente
                    </p>
                </div>
            </div>
            <a href="/logout" class="cyber-button logout-btn">
                <span>LOGOUT</span>
                <div class="cyber-button__glow"></div>
            </a>
        </div>

        <div class="dashboard-container">
            <div class="cyber-card">
                <h3>üîê CONFIGURAR TOKEN</h3>
                <p>Insira seu token do Discord uma vez e nunca mais precisar√° digitar</p>
                <div class="token-form">
                    <div class="form-group">
                        <label for="discordToken">Token do Discord:</label>
                        <input type="password" id="discordToken" class="form-input" 
                               placeholder="Insira seu token aqui...">
                    </div>
                    <button onclick="saveToken()" class="cyber-button">
                        <span>SALVAR TOKEN</span>
                        <div class="cyber-button__glow"></div>
                    </button>
                </div>
                <div id="tokenStatus" class="status-message" style="display: none;"></div>
                
                <!-- Status do Token -->
                <div class="token-status" style="margin-top: 1rem; padding: 0.5rem; border-radius: 5px; background: rgba(255, 0, 0, 0.1); border: 1px solid #ff0000;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <% if (token) { %>
                            ‚úÖ <strong>Token salvo:</strong> Voc√™ n√£o precisa digitar novamente
                        <% } else { %>
                            ‚ö†Ô∏è <strong>Nenhum token salvo:</strong> Configure abaixo
                        <% } %>
                    </p>
                </div>
            </div>

            <div class="cyber-card">
                <h3>üßπ LIMPAR DM</h3>
                <p>Limpe mensagens de um canal espec√≠fico</p>
                <div class="dm-form">
                    <div class="form-group">
                        <label for="channelId">Channel ID:</label>
                        <input type="text" id="channelId" class="form-input" 
                               placeholder="Insira o ID do canal...">
                    </div>
                    <button onclick="clearDM()" class="cyber-button">
                        <span>INICIAR LIMPEZA</span>
                        <div class="cyber-button__glow"></div>
                    </button>
                </div>
                <div id="dmStatus" class="status-message" style="display: none;"></div>

                <!-- Informa√ß√µes de uso -->
                <div class="mobile-tips" style="margin-top: 1rem;">
                    <h4>üì± Como usar:</h4>
                    <p style="font-size: 0.9rem; margin: 0.5rem 0;">
                        <strong>Channel ID:</strong> Clique com bot√£o direito no canal ‚Üí Copiar ID
                    </p>
                    <p style="font-size: 0.9rem; margin: 0;">
                        <strong>Token:</strong> Configure uma vez e use para sempre
                    </p>
                </div>
            </div>
        </div>

        <div class="cyber-card">
            <h3>üéØ NOVAS FUNCIONALIDADES</h3>
            <ul style="list-style: none; line-height: 1.6;">
                <li>‚úÖ <strong>Sess√£o permanente</strong> - 30 dias sem precisar refazer login</li>
                <li>‚úÖ <strong>Token salvo automaticamente</strong> - N√£o precisa digitar sempre</li>
                <li>‚úÖ <strong>Reconhecimento autom√°tico</strong> - Volte ao site j√° logado</li>
                <li>‚úÖ Sistema com rate limit autom√°tico (0.4-2s por mensagem)</li>
                <li>‚úÖ Sess√µes individuais para m√∫ltiplos usu√°rios</li>
                <li>‚ö†Ô∏è Mantenha seu token seguro e n√£o o compartilhe</li>
                <li>‚ö†Ô∏è O sistema s√≥ deleta mensagens enviadas por voc√™</li>
            </ul>
        </div>

        <!-- Guia Mobile -->
        <div class="cyber-card">
            <h3>üì± GUIA MOBILE</h3>
            <div class="mobile-steps">
                <div class="step">
                    <h4>1. Ativar Modo Desenvolvedor</h4>
                    <p>Discord ‚Üí Configura√ß√µes ‚Üí Avan√ßado ‚Üí Modo Desenvolvedor (ON)</p>
                </div>
                <div class="step">
                    <h4>2. Pegar Channel ID</h4>
                    <p>Toque no canal ‚Üí 3 pontos ‚Üí Copiar ID</p>
                </div>
                <div class="step">
                    <h4>3. Token (Apenas uma vez)</h4>
                    <p>Configure o token uma vez e nunca mais precise digitar!</p>
                    <button onclick="showTokenGuide()" class="cyber-button" style="margin-top: 0.5rem;">
                        <span>VER GUIA COMPLETO DO TOKEN</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="cyber-grid"></div>
    <div class="particles-container"></div>

    <script>
        // ========== SISTEMA DE TOKEN AUTOM√ÅTICO ========== //

        // Carregar token automaticamente ao abrir a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = '<%= token %>';
            console.log('Token salvo:', savedToken);
            
            if (savedToken && savedToken !== 'null' && savedToken !== '') {
                document.getElementById('discordToken').value = savedToken;
                showStatus('‚úÖ Token carregado automaticamente da sua sess√£o!', 'success');
            }
        });

        // Salvar token permanentemente
        function saveToken() {
            const token = document.getElementById('discordToken').value.trim();
            const statusDiv = document.getElementById('tokenStatus');
            
            if (!token) {
                showStatus('‚ùå Por favor, insira um token v√°lido.', 'error');
                return;
            }

            // Validar formato b√°sico do token
            if (!token.includes('.') || token.length < 50) {
                showStatus('‚ùå Token inv√°lido. Verifique o formato.', 'error');
                return;
            }
            
            showStatus('‚è≥ Salvando token permanentemente...', 'info');
            
            fetch('/save-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: token })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('‚úÖ ' + data.message, 'success');
                    // Recarregar a p√°gina para atualizar o status
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showStatus('‚ùå Erro: ' + data.error, 'error');
                }
            })
            .catch(error => {
                showStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
            });
        }

        // Limpar DM usando token salvo
        function clearDM() {
            const channelId = document.getElementById('channelId').value.trim();
            const statusDiv = document.getElementById('dmStatus');
            
            if (!channelId) {
                showStatus('‚ùå Por favor, insira um Channel ID v√°lido.', 'error', 'dmStatus');
                return;
            }

            // Validar channel ID (deve conter apenas n√∫meros)
            if (!/^\d+$/.test(channelId)) {
                showStatus('‚ùå Channel ID inv√°lido. Deve conter apenas n√∫meros.', 'error', 'dmStatus');
                return;
            }
            
            showStatus('üîß Iniciando limpeza... Isso pode levar alguns minutos. N√£o feche a p√°gina.', 'info', 'dmStatus');
            
            fetch('/clear-dm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ channelId: channelId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('‚úÖ ' + data.message, 'success', 'dmStatus');
                } else {
                    showStatus('‚ùå ' + data.error, 'error', 'dmStatus');
                }
            })
            .catch(error => {
                showStatus('‚ùå Erro de conex√£o: ' + error.message, 'error', 'dmStatus');
            });
        }

        // Guia para pegar token no mobile
        function showTokenGuide() {
            const guide = `
üì± COMO PEGAR TOKEN NO DISCORD:

‚ö†Ô∏è ATEN√á√ÉO: NUNCA COMPARTILHE SEU TOKEN!

1. Abra o Discord no navegador (PC)
2. Pressione F12 ‚Üí Console
3. Cole este c√≥digo e pressione Enter:

copy(webpackChunkdiscord_app.push([[Math.random()], {}, (e) => { m=[]; for(let x in e.c) m.push(e.c[x]) }]), m.find(m => m?.exports?.getToken))?.exports?.getToken()

4. O token ser√° copiado automaticamente
5. Cole no campo acima e clique em SALVAR

üéØ APENAS UMA VEZ: Depois de salvo, nunca mais precisar√° fazer isso!
            `;
            alert(guide);
        }

        // Sistema de notifica√ß√µes
        function showStatus(message, type, elementId = 'tokenStatus') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            // Rolagem suave para a mensagem
            statusDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Verificar se tem token salvo e mostrar instru√ß√µes
        window.onload = function() {
            const hasToken = '<%= token %>' && '<%= token %>' !== 'null' && '<%= token %>' !== '';
            
            if (!hasToken) {
                showStatus('‚ö†Ô∏è Configure seu token uma vez para usar todas as funcionalidades!', 'info');
            }
        }
    </script>
</body>
</html>
